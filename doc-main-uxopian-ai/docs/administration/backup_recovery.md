# Backup and Recovery

This section provides guidance on how to protect the critical data managed by the `uxopian-ai` framework. A proper backup strategy is essential to prevent data loss and ensure business continuity.

## üíæ What to Back Up

There are two primary sources of data you need to protect:

- **üõ† Configuration Files**: All the `.yml` files that define the service's behavior, including connections, provider settings, and default parameters.
- **üì¶ OpenSearch Data**: The OpenSearch instance stores all the dynamic data generated by user interactions, which includes conversations, messages, and the centrally managed Prompts and Goals.

## üß† Built-in YAML Backup for Prompts and Goals

The framework includes an automatic backup mechanism for Prompts and Goals. Whenever you create, update, or delete a prompt or goal via the API, the service automatically writes the current state of all prompts/goals to a YAML file.

This provides a persistent, file-based backup that can be easily version-controlled (e.g., with Git) and used for disaster recovery.

### ‚öôÔ∏è Configuration

You can configure the path and filename for these backup files in your configuration:

**For Prompts:**

```yaml
prompts:
  backup:
    path: ${PROMPTS_BACKUP_PATH:./prompts/}
    filename: ${PROMPTS_BACKUP_FILENAME:prompts-backup.yml}
```

**For Goals:**

```yaml
goals:
  backup:
    path: ${GOALS_BACKUP_PATH:./goals/}
    filename: ${GOALS_BACKUP_FILENAME:goals-backup.yml}
```

## üîÑ Restoring from YAML Backups

If you need to restore your Prompts and Goals from their backup files (e.g., after data loss in OpenSearch or when setting up a new environment), you can use the following methods:

### ‚úÖ Method 1: Loading from Files on Startup (Recommended)

This method uses the framework's ability to load Prompts and Goals from local YAML files on the classpath when the application starts.

1. **Prepare the Files**: Take your `prompts-backup.yml` and `goals-backup.yml` files. You can either use them as is or rename them (e.g., to `prompts.yml` and `goals.yml`).
2. **Place Files in Classpath**: Place these files in a directory that is part of the application's classpath (e.g., the `config` directory).
3. **Configure `application.yml`**:

```yaml
spring:
  config:
    import:
      - "optional:classpath:llm-clients-config.yml"
      - "optional:classpath:prompts.yml" # Your prompts file
      - "optional:classpath:goals.yml" # Your goals file
      - "classpath:opensearch.yml"
```

4. **Restart the Service**: When `uxopian-ai` starts, it will read the contents of the imported files and automatically load them into OpenSearch.

### üß™ Method 2: Manual Restore via API

You can also manually restore prompts and goals by copying their definitions from the YAML backup file and using the API.

1. Open your `prompts-backup.yml` or `goals-backup.yml` file.
2. For each entry, construct a JSON payload corresponding to the prompt or goal.
3. Use the `POST /prompt` or `POST /goal` API endpoint to re-create each entry one by one.

## üß© Merge Strategies for YAML Restoration

When restoring Prompts and Goals from YAML files, the framework supports multiple merge strategies to control how data is integrated into OpenSearch.

### üîÅ Strategy: `Override`

- **Prompts**:

  - All existing prompts in OpenSearch are **deleted**.
  - Prompts from the YAML file are **fully re-created** based on their `id`.

- **Goals**:

  - All existing goals are **deleted**.
  - Goals from the YAML file are **fully re-created** based on their `name`.

Use this mode when you want a **clean slate** and full replacement of current definitions.

---

### ‚ûï Strategy: `Merge`

- **Prompts**:

  - For each prompt in the YAML file:

    - If a prompt with the same `id` exists: missing values are **merged** into the existing prompt.
    - If it doesn't exist: it is **created**.

- **Goals**:

  - For each goal in the YAML file:

    - If a goal with the same `name` exists:

      - New values are added to the existing goal.
      - Missing fields are **merged**, but no data is removed.

    - If it doesn‚Äôt exist: it is **created**.

Use this mode to **augment existing definitions** without removing anything.

---

### üÜï Strategy: `CreateIfMissing`

- **Prompts**:

  - Only prompts with new `id`s are added.
  - Existing prompts are left **untouched**.

- **Goals**:

  - Only goals with new `name`s are added.
  - Existing goals are left **untouched**.

Use this mode to **safely append** new definitions while preserving the current state.

## üóÇ Backup Strategy Table

The following table summarizes what to back up and the recommended method for each type of data:

| Entity        | Primary Storage   | Backup Mechanism     | Recommended Method                                                                        |
| ------------- | ----------------- | -------------------- | ----------------------------------------------------------------------------------------- |
| Configuration | Filesystem (.yml) | N/A                  | Backup the configuration directory/files.                                                 |
| Conversations | OpenSearch Index  | OpenSearch Snapshots | Schedule periodic OpenSearch snapshots.                                                   |
| Messages      | OpenSearch Index  | OpenSearch Snapshots | Schedule periodic OpenSearch snapshots.                                                   |
| Goals         | OpenSearch Index  | Built-in YAML Backup | Schedule OpenSearch snapshots **and** commit the `goals-backup.yml` to version control.   |
| Prompts       | OpenSearch Index  | Built-in YAML Backup | Schedule OpenSearch snapshots **and** commit the `prompts-backup.yml` to version control. |

## ‚úÖ Key Recommendations

- **üìÜ Automate your backups**: Schedule regular, automated backups for both your configuration files and your OpenSearch cluster.
- **üóÉ Version control your backups**: Use a version control system like Git for your main configuration files and the YAML backups of your prompts and goals.
- **üîÅ Test your recovery process**: Periodically test restoring from a backup to ensure your strategy works as expected.
- **üîê Store backups securely**: Keep your backups in a separate, secure location.
