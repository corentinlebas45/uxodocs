sequenceDiagram
    participant Client
    participant uxopian-ai Service
    participant OpenSearch
    participant External LLM

    Client->>+uxopian-ai Service: POST /message/{conv_id} <br/> { goalName: "compare", payload: {...} }
    uxopian-ai Service->>uxopian-ai Service: Identify message type (Goal > PromptId > Content)
    Note over uxopian-ai Service: Goal detected. Resolving...

    uxopian-ai Service->>+OpenSearch: Find Goal named "compare"
    OpenSearch-->>-uxopian-ai Service: Return matching Goal definitions

    uxopian-ai Service->>uxopian-ai Service: Evaluate Goal filters vs. payload
    Note over uxopian-ai Service: Filter matches => selects promptId: "detailedComparison"

    uxopian-ai Service->>+OpenSearch: Get Prompt by ID "detailedComparison"
    OpenSearch-->>-uxopian-ai Service: Return Prompt template

    uxopian-ai Service->>+OpenSearch: Get recent conversation messages
    OpenSearch-->>-uxopian-ai Service: Return context history

    uxopian-ai Service->>uxopian-ai Service: Render final prompt with Thymeleaf

    uxopian-ai Service->>+External LLM: Send rendered prompt
    External LLM-->>-uxopian-ai Service: Return LLM-generated response

    uxopian-ai Service->>+OpenSearch: Persist user message and LLM response
    OpenSearch-->>-uxopian-ai Service: Confirm storage

    uxopian-ai Service-->>-Client: Return response
